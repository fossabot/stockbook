package stockbook

import (
	"strings"
	"testing"
	"time"

	"github.com/stretchr/testify/assert"
	"github.com/suwenyu/stockbook/utils"
)

func TestURL(t *testing.T) {
	var d = NewTWSE("2330", time.Date(2021, 8, 23, 10, 38, 3, 0, utils.TaipeiTimeZone))

	assert.Equal(t, d.URL(), "http://www.twse.com.tw/exchangeReport/STOCK_DAY?response=json&date=20210823&stockNo=2330")
}

func TestMinusMonth(t *testing.T) {
	var d = NewTWSE("2618", time.Date(2021, 8, 23, 0, 0, 0, 0, utils.TaipeiTimeZone))
	var expected = time.Date(2021, 7, 1, 0, 0, 0, 0, utils.TaipeiTimeZone)
	assert.Equal(t, d.Date, time.Date(2021, 8, 23, 0, 0, 0, 0, utils.TaipeiTimeZone))

	d.MinusMonth()
	assert.Equal(t, d.Date, expected)

}

func TestGet(t *testing.T) {
	old := GetJson
	defer func() { GetJson = old }()
	GetJson = func(url string) ([]byte, error) {
		// This will be called, do whatever you want to,
		// return whatever you want to
		var data []byte
		data = []byte(`{"stat":"OK","date":"20210823","title":"110年08月 2330 台積電           各日成交資訊","fields":["日期","成交股數","成交金額","開盤價","最高價","最低價","收盤價","漲跌價差","成交筆數"],"data":[["110/08/02","24,948,096","14,593,329,483","583.00","590.00","580.00","590.00","+10.00","19,791"],["110/08/03","28,104,984","16,655,446,605","594.00","594.00","590.00","594.00","+4.00","20,221"],["110/08/04","23,714,971","14,132,827,829","598.00","598.00","594.00","596.00","+2.00","18,228"],["110/08/05","15,673,765","9,343,887,536","598.00","598.00","593.00","596.00"," 0.00","15,495"],["110/08/06","13,994,018","8,275,142,201","596.00","596.00","588.00","591.00","-5.00","13,742"],["110/08/09","17,611,955","10,366,798,182","590.00","595.00","583.00","595.00","+4.00","15,068"],["110/08/10","17,620,825","10,435,618,093","596.00","596.00","589.00","591.00","-4.00","13,983"],["110/08/11","20,311,399","11,943,131,619","590.00","590.00","585.00","590.00","-1.00","18,548"],["110/08/12","16,031,265","9,383,967,628","586.00","588.00","584.00","586.00","-4.00","15,202"],["110/08/13","25,440,973","14,769,155,709","585.00","585.00","579.00","581.00","-5.00","36,198"],["110/08/16","19,949,389","11,612,486,234","582.00","586.00","578.00","584.00","+3.00","17,055"],["110/08/17","31,845,499","18,475,506,150","580.00","582.00","578.00","580.00","-4.00","19,184"],["110/08/18","47,063,629","26,855,353,529","568.00","575.00","566.00","574.00","-6.00","86,118"],["110/08/19","42,133,375","23,766,228,074","573.00","573.00","559.00","559.00","-15.00","119,048"],["110/08/20","47,741,449","26,565,551,162","560.00","563.00","551.00","552.00","-7.00","72,684"],["110/08/23","34,775,337","19,688,362,857","560.00","572.00","559.00","566.00","+14.00","30,421"]],"notes":["符號說明:+/-/X表示漲/跌/不比價","當日統計資訊含一般、零股、盤後定價、鉅額交易，不含拍賣、標購。","ETF證券代號第六碼為K、M、S、C者，表示該ETF以外幣交易。"]}`)

		return data, nil

	}

	var d = NewTWSE("2330", time.Date(2021, 8, 23, 0, 0, 0, 0, utils.TaipeiTimeZone))
	var resp [][]string
	resp, _ = d.Get()

	assert.NotEqual(t, len(resp), 0)
}

func TestFormatData(t *testing.T) {
	date := time.Date(2021, 8, 23, 0, 0, 0, 0, utils.TaipeiTimeZone)
	var d = NewTWSE("2330", date)
	d.Get()
	var resp []StockInfo
	resp = d.FormatData()

	// ts := time.Unix(date, 0)
	assert.Equal(t, resp[0].Date, date)

}

func TestRetrievePrevMonth(t *testing.T) {
	old := GetJson
	defer func() { GetJson = old }()
	GetJson = func(url string) ([]byte, error) {
		// This will be called, do whatever you want to,
		// return whatever you want to
		var data []byte
		if strings.Contains(url, "202108") {
			data = []byte(`{"stat":"OK","date":"20210823","title":"110年08月 2330 台積電           各日成交資訊","fields":["日期","成交股數","成交金額","開盤價","最高價","最低價","收盤價","漲跌價差","成交筆數"],"data":[["110/08/02","24,948,096","14,593,329,483","583.00","590.00","580.00","590.00","+10.00","19,791"],["110/08/03","28,104,984","16,655,446,605","594.00","594.00","590.00","594.00","+4.00","20,221"],["110/08/04","23,714,971","14,132,827,829","598.00","598.00","594.00","596.00","+2.00","18,228"],["110/08/05","15,673,765","9,343,887,536","598.00","598.00","593.00","596.00"," 0.00","15,495"],["110/08/06","13,994,018","8,275,142,201","596.00","596.00","588.00","591.00","-5.00","13,742"],["110/08/09","17,611,955","10,366,798,182","590.00","595.00","583.00","595.00","+4.00","15,068"],["110/08/10","17,620,825","10,435,618,093","596.00","596.00","589.00","591.00","-4.00","13,983"],["110/08/11","20,311,399","11,943,131,619","590.00","590.00","585.00","590.00","-1.00","18,548"],["110/08/12","16,031,265","9,383,967,628","586.00","588.00","584.00","586.00","-4.00","15,202"],["110/08/13","25,440,973","14,769,155,709","585.00","585.00","579.00","581.00","-5.00","36,198"],["110/08/16","19,949,389","11,612,486,234","582.00","586.00","578.00","584.00","+3.00","17,055"],["110/08/17","31,845,499","18,475,506,150","580.00","582.00","578.00","580.00","-4.00","19,184"],["110/08/18","47,063,629","26,855,353,529","568.00","575.00","566.00","574.00","-6.00","86,118"],["110/08/19","42,133,375","23,766,228,074","573.00","573.00","559.00","559.00","-15.00","119,048"],["110/08/20","47,741,449","26,565,551,162","560.00","563.00","551.00","552.00","-7.00","72,684"],["110/08/23","34,775,337","19,688,362,857","560.00","572.00","559.00","566.00","+14.00","30,421"]],"notes":["符號說明:+/-/X表示漲/跌/不比價","當日統計資訊含一般、零股、盤後定價、鉅額交易，不含拍賣、標購。","ETF證券代號第六碼為K、M、S、C者，表示該ETF以外幣交易。"]}`)
		} else if strings.Contains(url, "202107") {
			data = []byte(`{"stat":"OK","date":"20210701","title":"110年07月 2330 台積電           各日成交資訊","fields":["日期","成交股數","成交金額","開盤價","最高價","最低價","收盤價","漲跌價差","成交筆數"],"data":[["110/07/01","18,719,706","11,116,195,742","596.00","597.00","591.00","593.00","-2.00","20,565"],["110/07/02","19,633,718","11,562,140,245","590.00","593.00","587.00","588.00","-5.00","24,056"],["110/07/05","30,274,105","17,957,255,325","588.00","597.00","588.00","591.00","+3.00","21,836"],["110/07/06","13,830,591","8,185,167,307","595.00","596.00","589.00","592.00","+1.00","15,751"],["110/07/07","17,329,148","10,250,342,169","590.00","594.00","588.00","594.00","+2.00","18,023"],["110/07/08","21,596,183","12,733,045,117","595.00","595.00","588.00","588.00","-6.00","23,352"],["110/07/09","30,602,492","17,821,338,170","582.00","585.00","580.00","584.00","-4.00","51,232"],["110/07/12","33,011,596","19,612,592,644","595.00","597.00","590.00","593.00","+9.00","28,636"],["110/07/13","54,894,335","33,158,730,436","600.00","608.00","599.00","607.00","+14.00","60,121"],["110/07/14","39,670,241","24,276,719,505","613.00","615.00","608.00","613.00","+6.00","43,173"],["110/07/15","23,057,868","14,117,908,308","613.00","614.00","608.00","614.00","+1.00","29,913"],["110/07/16","61,882,128","36,562,482,701","591.00","595.00","588.00","589.00","-25.00","86,192"],["110/07/19","43,248,966","25,135,531,384","583.00","584.00","578.00","582.00","-7.00","86,753"],["110/07/20","16,352,855","9,502,338,666","579.00","584.00","579.00","581.00","-1.00","27,956"],["110/07/21","26,476,215","15,440,430,690","586.00","586.00","580.00","585.00","+4.00","32,757"],["110/07/22","27,075,950","16,014,166,571","589.00","594.00","587.00","591.00","+6.00","23,365"],["110/07/23","15,705,191","9,206,201,715","592.00","592.00","583.00","585.00","-6.00","23,635"],["110/07/26","22,442,745","13,089,591,086","591.00","591.00","580.00","580.00","-5.00","37,826"],["110/07/27","18,925,325","10,997,959,654","581.00","584.00","580.00","580.00"," 0.00","20,197"],["110/07/28","39,744,486","22,884,618,824","576.00","579.00","573.00","579.00","-1.00","75,078"],["110/07/29","25,014,772","14,525,643,464","585.00","585.00","577.00","583.00","+4.00","26,868"],["110/07/30","26,141,286","15,170,421,873","581.00","582.00","578.00","580.00","-3.00","16,353"]],"notes":["符號說明:+/-/X表示漲/跌/不比價","當日統計資訊含一般、零股、盤後定價、鉅額交易，不含拍賣、標購。","ETF證券代號第六碼為K、M、S、C者，表示該ETF以外幣交易。"]}`)
		} else if strings.Contains(url, "202106") {
			data = []byte(`{"stat":"OK","date":"20210601","title":"110年06月 2330 台積電           各日成交資訊","fields":["日期","成交股數","成交金額","開盤價","最高價","最低價","收盤價","漲跌價差","成交筆數"],"data":[["110/06/01","18,405,285","10,985,893,229","598.00","599.00","595.00","598.00","+1.00","20,318"],["110/06/02","22,416,789","13,362,065,937","600.00","600.00","593.00","595.00","-3.00","25,170"],["110/06/03","31,703,679","18,939,839,664","600.00","600.00","596.00","596.00","+1.00","20,749"],["110/06/04","16,072,580","9,521,252,157","591.00","595.00","590.00","595.00","-1.00","19,112"],["110/06/07","17,729,179","10,471,176,330","594.00","595.00","583.00","592.00","-3.00","25,364"],["110/06/08","14,083,552","8,312,653,665","590.00","595.00","588.00","589.00","-3.00","14,051"],["110/06/09","21,575,159","12,618,113,390","586.00","588.00","583.00","586.00","-3.00","36,405"],["110/06/10","29,741,770","17,696,413,894","591.00","599.00","587.00","599.00","+13.00","30,487"],["110/06/11","24,940,705","15,011,140,567","602.00","603.00","600.00","602.00","+3.00","25,271"],["110/06/15","30,245,897","18,415,370,774","607.00","609.00","606.00","609.00","+7.00","33,515"],["110/06/16","28,624,508","17,401,326,587","608.00","608.00","605.00","605.00","-4.00","25,816"],["110/06/17","26,477,032","15,924,656,516","601.00","606.00","598.00","606.00","X0.00","21,061"],["110/06/18","42,036,170","25,373,026,235","608.00","608.00","601.00","603.00","-3.00","16,899"],["110/06/21","47,339,695","27,749,202,661","590.00","594.00","583.00","583.00","-20.00","109,204"],["110/06/22","30,578,091","17,786,329,582","585.00","588.00","578.00","578.00","-5.00","56,057"],["110/06/23","36,386,023","21,500,052,844","583.00","598.00","581.00","595.00","+17.00","34,454"],["110/06/24","19,322,765","11,435,647,488","598.00","598.00","588.00","590.00","-5.00","18,494"],["110/06/25","19,140,086","11,355,715,486","598.00","598.00","589.00","591.00","+1.00","16,850"],["110/06/28","15,401,977","9,056,869,217","590.00","590.00","586.00","590.00","-1.00","20,825"],["110/06/29","30,837,548","18,350,027,611","598.00","598.00","591.00","595.00","+5.00","24,078"],["110/06/30","34,021,380","20,301,841,661","599.00","599.00","595.00","595.00"," 0.00","20,097"]],"notes":["符號說明:+/-/X表示漲/跌/不比價","當日統計資訊含一般、零股、盤後定價、鉅額交易，不含拍賣、標購。","ETF證券代號第六碼為K、M、S、C者，表示該ETF以外幣交易。"]}`)
		}

		return data, nil

	}
	date := time.Date(2021, 8, 23, 0, 0, 0, 0, utils.TaipeiTimeZone)

	var d1 = NewTWSE("2330", date)
	d1.RetrievePrevMonth(2)
	d1Data := d1.FormatData()

	var d2 = NewTWSE("2330", date)
	d2.Get()
	d2Data := d2.FormatData()

	assert.NotEqual(t, len(d1Data), len(d2Data))
	assert.Equal(t, d1Data[len(d1Data)-1].Date, time.Date(2021, 6, 1, 0, 0, 0, 0, utils.TaipeiTimeZone))

}
